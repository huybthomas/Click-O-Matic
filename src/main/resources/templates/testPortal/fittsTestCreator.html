<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="testPortal/layout :: head (pageTitle='Fittstest creator')"></head>
<head>
    <!-- Included bootstrap-slider -->
    <link href="https://cdn.rawgit.com/davidstutz/bootstrap-multiselect/v0.9.13/dist/css/bootstrap-multiselect.css"
          th:href="@{/webjars/seiyria-bootstrap-slider/5.2.6/dist/css/bootstrap-slider.min.css}"
          rel="stylesheet" media="screen"/>

    <script src="https://cdn.rawgit.com/davidstutz/bootstrap-multiselect/v0.9.13/dist/js/bootstrap-multiselect.js"
            th:src="@{/webjars/seiyria-bootstrap-slider/5.2.6/dist/bootstrap-slider.min.js}"></script>

    <!-- Included FittsTest scripts -->
    <!-- Included scripts -->
    <script type="text/javascript" th:src="'/js/fittsTest/FittsDot.js?v=' + #{application.version.main} + '.' + #{application.version.minor}"></script>
    <script type="text/javascript" th:src="'/js/fittsTest/FittsTrackEvent.js?v=' + #{application.version.main} + '.' + #{application.version.minor}"></script>
    <script type="text/javascript" th:src="'/js/fittsTest/FittsTrackPath.js?v=' + #{application.version.main} + '.' + #{application.version.minor}"></script>

    <script type="text/javascript" th:src="'/js/fittsTest/FittsTestStage.js?v=' + #{application.version.main} + '.' + #{application.version.minor}"></script>
    <script type="text/javascript" th:src="'/js/fittsTest/FittsTest.js?v=' + #{application.version.main} + '.' + #{application.version.minor}"></script>
</head>
<body>
    <div class="container">
        <!-- Import navigation bar -->
        <div th:replace="testPortal/layout :: navbar"></div>

        <div class="content">
            <div class="messagesContent">
                <div th:if="${param.error}" class="alert alert-danger" role="alert" style="text-align:center; width:500px; left:0; right:0; margin-left:auto; margin-right:auto; position:absolute">
                    <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                    <span class="sr-only">Error: </span>
                    <span th:text="#{fittsTestCreator.alerts.error}">Error message</span>
                </div>
            </div>
            <div class="testPortalPage">
                <h2 th:text="#{fittstest.createTitle}"></h2>
                <form action="javascript:sendFittsTest();" th:object="${fittsTest}">
                    <table class="table-responsive col-md-6" style="line-height: 40px;">
                        <tr>
                            <div class="form-group">
                                <td th:text="#{fittstest.uniqueName}"></td>
                                <td><input id="fittsTestID" class="form-control" type="text" th:field="*{testID}"/></td>
                            </div>
                        </tr>
                        <tr>
                            <div class="form-group">
                                <td th:text="#{fittstest.comment}"></td>
                                <td><textarea id="fittsTestComment" class="form-control" type="text" th:field="*{comment}"></textarea></td>
                            </div>
                        </tr>
                        <tr>
                            <td id="dotAmt" th:text="#{fittstest.amtOfDotsMsg}"></td>
                            <td><input id="numberOfDotsSlider" type="text" data-slider-tooltip="hide"/></td>
                        </tr>
                        <tr>
                            <td id="dotRad" th:text="#{fittstest.dotRadiusMsg}"></td>
                            <td><input id="dotRadiusSlider" type="text" data-slider-tooltip="hide"/></td>
                        </tr>
                        <tr>
                            <td id="dotDist" th:text="#{fittstest.dotDistanceMsg}"></td>
                            <td><input id="dotDistanceSlider" type="text" data-slider-tooltip="hide"/></td>
                        </tr>
                    </table>

                    <h3 class="col-md-6" th:text="#{fittstest.stages}"></h3>
                    <div class="col-xs-4">
                        <p id="amtOfStages" style="float: right; font-size: smaller">Number of stages: </p>
                        <select id="stagesSelector" th:field="*{testStages}" class="form-control" onchange="setSliders()"></select>
                        <button id="AddStage" type="button" class="btn btn-default" th:text="#{fittsTestCreator.createStage}" onclick="addStage();"/>
                        <button id="DeleteStage" type="button" class="btn btn-danger" th:text="#{fittsTestCreator.deleteStage}" onclick="removeStage();"/>
                    </div>
                    <p class="col-md-12">
                        <input type="submit" class="btn btn-primary" th:value="#{fittsTestCreator.create}"/>
                    </p>
                    <div class="frontContent" id="frontContent">
                        <!-- Fitts test -->
                        <canvas id="FittsPreviewCanvas"></canvas>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Import footer -->
    <div th:replace="testPortal/layout :: footer"></div>

    <!-- Resize canvas script -->
    <script type="text/javascript">
        window.addEventListener('resize', resizeEvent, false);

        //Initial sizing
        resizeEvent();

        function resizeEvent(event)
        {
            var frontContent = document.getElementById("frontContent");
            var FittsPreviewCanvas = document.getElementById("FittsPreviewCanvas");

            var newWidth = frontContent.offsetWidth;
            var newHeight = window.innerHeight * 0.9;  // Y positioning of canvas, not ideal yet.

            FittsPreviewCanvas.width = newWidth;
            FittsPreviewCanvas.height = newHeight;
        }
    </script>

    <!-- Slider scripts -->
    <script type="text/javascript">
        var numberOfDotsSlider = new Slider("#numberOfDotsSlider", {step: 2, min: 3, max: 21});
        var dotRadiusSlider = new Slider("#dotRadiusSlider", {step: 1, min: 5, max: 150});
        var dotDistanceSlider = new Slider("#dotDistanceSlider", {step: 1, min: 20, max: 300});
    </script>

    <!-- Load vars -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        var testAttr=/*[[${fittsTest}]]*/;
        var amtOfStagesMsg=/*[[#{fittstest.amtOfStages}]]*/;
        var amtOfDotsMsg=/*[[#{fittstest.amtOfDotsMsg}]]*/;
        var dotRadiusMsg=/*[[#{fittstest.dotRadiusMsg}]]*/;
        var dotDistanceMsg=/*[[#{fittstest.dotDistanceMsg}]]*/;
        var stageMsg=/*[[#{fittstest.stage}]]*/;

        var selector = document.getElementById("stagesSelector");
        var selectOptions = testAttr.testStages;
        /*]]>*/
    </script>

    <!-- Import FittsTestPreview -->
    <script type="text/javascript" th:src="'/js/fittsTest/FittsTestPreview.js?v=' + #{application.version.main} + '.' + #{application.version.minor}"></script>

    <!-- Test stages script -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        generateOptions();

        function generateOptions() {
            <!-- clear all options -->
            selector.options.length = 0;

            if(selectOptions.length > 0) {
                <!-- add all options -->
                for (i = 0; i < selectOptions.length; i++) {
                    var option = document.createElement("option");
                    option.text = stageMsg + " " + (i + 1).toString();
                    if (selectOptions[i].id) {
                        option.value = selectOptions[i].id;
                    } else {
                        option.value = "";
                    }
                    selector.appendChild(option);
                }
                setSliders();
            } else {
                // disable sliders and selection
                $('#stagesSelector').prop('disabled', 'disabled');
                numberOfDotsSlider.disable();
                dotRadiusSlider.disable();
                dotDistanceSlider.disable();
            }
            setAmtOfStages();
        }

        function addStage() {
            selectOptions.push(new FittsTestStage(3, 5, 20));
            addOption();
            setAmtOfStages();
        }

        function addOption() {
            $('#stagesSelector').prop('disabled', false);
            var option = document.createElement("option");
            option.text = stageMsg + " " + selectOptions.length;
            if(selectOptions[selectOptions.length-1].id) {
                option.value = selectOptions[selectOptions.length-1].id;
            } else {
                option.value = "";
            }
            selector.appendChild(option);
            selector.selectedIndex = selectOptions.length-1;
            setSliders();
        }

        function removeStage() {
            selectOptions.splice(selector.selectedIndex, 1);
            selector.options.remove(selector.selectedIndex);
            setAmtOfStages(selectOptions.length);
            generateOptions();
        }

        function setAmtOfStages() {
            if(selectOptions.length > 0) {
                $("#amtOfStages").text(amtOfStagesMsg + " " + selectOptions.length);
            } else {
                $("#amtOfStages").text(amtOfStagesMsg + " 0");
            }
        }

        function setSliders() {
            stage = selectOptions[selector.selectedIndex];
            numberOfDotsSlider.enable();
            dotRadiusSlider.enable();
            dotDistanceSlider.enable();
            numberOfDotsSlider.setValue(stage.numberOfDots);
            dotRadiusSlider.setValue(stage.dotRadius);
            dotDistanceSlider.setValue(stage.dotDistance);
            $("#dotAmt").text(amtOfDotsMsg + " " + stage.numberOfDots);
            $("#dotRad").text(dotRadiusMsg + " " + stage.dotRadius);
            $("#dotDist").text(dotDistanceMsg + " " + stage.dotDistance);

            setStage();
        }

        $("#numberOfDotsSlider").bind("slide slideStop", function(slideEvt) {
            selectOptions[selector.selectedIndex].numberOfDots = slideEvt.value;
            $("#dotAmt").text(amtOfDotsMsg + " " + slideEvt.value);
            initDots();
        });

        $("#dotRadiusSlider").bind("slide slideStop", function(slideEvt) {
            selectOptions[selector.selectedIndex].dotRadius = slideEvt.value;
            $("#dotRad").text(dotRadiusMsg + " " + slideEvt.value);
            initDots();
        });

        $("#dotDistanceSlider").bind("slide slideStop", function(slideEvt) {
            selectOptions[selector.selectedIndex].dotDistance = slideEvt.value;
            $("#dotDist").text(dotDistanceMsg + " " + slideEvt.value);
            initDots();
        });


        function sendFittsTest()
        {
            testAttr.testID = document.getElementById("fittsTestID").value;
            testAttr.comment = document.getElementById("fittsTestComment").value;
            testAttr.testStages = selectOptions;
            testAttr.numberOfStages = selectOptions.length;
            testAttr.testFinished = false;

            if((testAttr.testStages.length > 0) && (testAttr.testID != "")){
                $.ajax({
                    type: "POST",
                    url: "/PostFittsTest/",
                    data: JSON.stringify(testAttr),           //"fittsTest" will be value for @RequestParam
                    contentType: "application/json",
                    success: function(response) {
                        if(response.status = "OK")
                        {
                            window.location.replace(response.redirect);
                        }
                        else
                        {
                            receiveError(response.message);
                        }
                    },
                    error: function(response) {
                        receiveError("Connection lost with the server! An error occurred when trying to contact the server.\nError-message: " + response.responseJSON.message);
                    }
                });
            }
            else
            {
                if(testAttr.testStages.length <= 0)
                {

                }
                else
                {

                }

                if(testAttr.testID == "")
                {
                    divTestID = $("#fittsTestID").parents("div.control-group");
                    divTestID.removeClass("success");
                    divTestID.addClass("error");
                }
                else
                {
                    divTestID = $("#fittsTestID").parents("div.control-group");
                    divTestID.removeClass("error");
                    divTestID.addClass("success");
                }
            }
        }

        function receiveError(response)
        {
            alert("ERROR");
            //Error, TestId is not unique
            divTestID = $("#fittsTestID").parents("div.control-group");
            divTestID.removeClass("success");
            divTestID.addClass("error");
        }
        /*]]>*/
    </script>

</body>
</html>