<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="testPortal/layout :: head (pageTitle='Fittstest creator')"></head>
<head>
    <!-- Included bootstrap-slider -->
    <link href="https://cdn.rawgit.com/seiyria/bootstrap-slider/v5.2.6/dist/css/bootstrap-slider.min.css"
          th:href="@{/webjars/seiyria-bootstrap-slider/5.2.6/dist/css/bootstrap-slider.min.css}"
          rel="stylesheet" media="screen"/>

    <script src="https://cdn.rawgit.com/seiyria/bootstrap-slider/v5.2.6/dist/bootstrap-slider.min.js"
            th:src="@{/webjars/seiyria-bootstrap-slider/5.2.6/dist/bootstrap-slider.min.js}"></script>

    <!-- Included FittsTest scripts -->
    <script type="text/javascript" th:src="'/js/fittsTest/FittsTestStage.js?v=' + #{application.version.main} + '.' + #{application.version.minor}"></script>
    <script type="text/javascript" th:src="'/js/fittsTest/FittsTest.js?v=' + #{application.version.main} + '.' + #{application.version.minor}"></script>

</head>
<body>

    <div class="container">
        <!-- Import navigation bar -->
        <div th:replace="testPortal/layout :: navbar"></div>

        <div class="content">
            <p th:if="${param.success}" class="alert" th:text="#{fittsTestCreator.alerts.success}">New user has been created</p>
            <p th:if="${param.error}" class="alert alert-error" th:text="#{fittsTestCreator.alerts.error}">There was an error, please try again</p>
            <p th:if="${param.errorAlreadyExists}" class="alert alert-error" th:text="#{fittsTestCreator.alerts.errorAlreadyExists}">Unique ID already exists! Choose another username and try again.</p>
            <div class="testPortalPage">
                <h2 th:text="#{fittstest.createTitle}"></h2>
                <form action="javascript:sendFittsTest();" th:object="${fittsTest}">
                    <table class="table-responsive col-md-6">
                        <tr>
                            <td th:text="#{fittstest.uniqueName}"></td>
                            <td><input id="fittsTestID" type="text" th:field="*{testID}"/> </td>
                        </tr>
                        <tr>
                            <td id="dotAmt" th:text="#{fittstest.amtOfDotsMsg}"></td>
                            <td><input id="numberOfDotsSlider" type="text"/></td>
                        </tr>
                        <tr>
                            <td id="dotRad" th:text="#{fittstest.dotRadiusMsg}"></td>
                            <td><input id="dotRadiusSlider" type="text"/></td>
                        </tr>
                        <tr>
                            <td id="dotDist" th:text="#{fittstest.dotDistanceMsg}"></td>
                            <td><input id="dotDistanceSlider" type="text"/></td>
                        </tr>
                    </table>

                    <h3 class="col-md-6" th:text="#{fittstest.stages}"></h3>
                    <div class="col-xs-4">
                        <p id="amtOfStages" style="float: right; font-size: smaller">Number of stages: </p>
                        <select id="stagesSelector" th:field="*{testStages}" class="form-control" onchange="setSliders()"></select>
                        <input id="AddStage" class="btn btn-default" th:value="#{fittsTestCreator.createStage}" onclick="addStage();"/>
                        <input id="DeleteStage" class="btn btn-danger" th:value="#{fittsTestCreator.deleteStage}" onclick="removeStage();"/>
                    </div>
                    <p class="col-md-12">
                        <input type="submit" class="btn btn-primary" th:value="#{fittsTestCreator.create}"/>
                    </p>
                </form>
            </div>
        </div>
    </div>

    <!-- Import footer -->
    <div th:replace="testPortal/layout :: footer"></div>

    <!-- Slider scripts -->
    <script type="text/javascript">
        var numberOfDotsSlider = new Slider("#numberOfDotsSlider", {step: 2, min: 3, max: 21});
        var dotRadiusSlider = new Slider("#dotRadiusSlider", {step: 1, min: 5, max: 150});
        var dotDistanceSlider = new Slider("#dotDistanceSlider", {step: 1, min: 20, max: 300});
    </script>

    <!-- Test stages scripts -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        var testAttr=/*[[${fittsTest}]]*/;
        var amtOfStagesMsg=/*[[#{fittstest.amtOfStages}]]*/;
        var amtOfDotsMsg=/*[[#{fittstest.amtOfDotsMsg}]]*/;
        var dotRadiusMsg=/*[[#{fittstest.dotRadiusMsg}]]*/;
        var dotDistanceMsg=/*[[#{fittstest.dotDistanceMsg}]]*/;
        var stageMsg=/*[[#{fittstest.stage}]]*/;

        var selector = document.getElementById("stagesSelector");
        var selectOptions = testAttr.testStages;
        generateOptions();

        function generateOptions() {
            <!-- clear all options -->
            selector.options.length = 0;

            if(selectOptions.length > 0) {
                <!-- add all options -->
                for (i = 0; i < selectOptions.length; i++) {
                    var option = document.createElement("option");
                    option.text = stageMsg + " " + (i + 1).toString();
                    if (selectOptions[i].id) {
                        option.value = selectOptions[i].id;
                    } else {
                        option.value = "";
                    }
                    selector.appendChild(option);
                }
                setSliders();
            } else {
                // disable sliders and selection
                $('#stagesSelector').prop('disabled', 'disabled');
                numberOfDotsSlider.disable();
                dotRadiusSlider.disable();
                dotDistanceSlider.disable();
            }
            setAmtOfStages();
        }

        function addStage() {
            selectOptions.push(new FittsTestStage(3, 5, 20));
            addOption();
            setAmtOfStages();
        }

        function addOption() {
            $('#stagesSelector').prop('disabled', false);
            var option = document.createElement("option");
            option.text = stageMsg + " " + selectOptions.length;
            if(selectOptions[selectOptions.length-1].id) {
                option.value = selectOptions[selectOptions.length-1].id;
            } else {
                option.value = "";
            }
            selector.appendChild(option);
            selector.selectedIndex = selectOptions.length-1;
            setSliders();
        }

        function removeStage() {
            selectOptions.splice(selector.selectedIndex, 1);
            selector.options.remove(selector.selectedIndex);
            setAmtOfStages(selectOptions.length);
            generateOptions();
        }

        function setAmtOfStages() {
            if(selectOptions.length > 0) {
                $("#amtOfStages").text(amtOfStagesMsg + " " + selectOptions.length);
            } else {
                $("#amtOfStages").text(amtOfStagesMsg + " 0");
            }
        }

        function setSliders() {
            stage = selectOptions[selector.selectedIndex];
            numberOfDotsSlider.enable();
            dotRadiusSlider.enable();
            dotDistanceSlider.enable();
            numberOfDotsSlider.setValue(stage.numberOfDots);
            dotRadiusSlider.setValue(stage.dotRadius);
            dotDistanceSlider.setValue(stage.dotDistance);
            $("#dotAmt").text(amtOfDotsMsg + " " + stage.numberOfDots);
            $("#dotRad").text(dotRadiusMsg + " " + stage.dotRadius);
            $("#dotDist").text(dotDistanceMsg + " " + stage.dotDistance);

        }

        numberOfDotsSlider.on("slideStop", function(slideEvt) {
            selectOptions[selector.selectedIndex].numberOfDots = slideEvt;
            $("#dotAmt").text(amtOfDotsMsg + " " + slideEvt);
        });

        dotRadiusSlider.on("slideStop", function(slideEvt) {
            selectOptions[selector.selectedIndex].dotRadius = slideEvt;
            $("#dotRad").text(dotRadiusMsg + " " + slideEvt);
        });

        dotDistanceSlider.on("slideStop", function(slideEvt) {
            selectOptions[selector.selectedIndex].dotDistance = slideEvt;
            $("#dotDist").text(dotDistanceMsg + " " + slideEvt);
        });


        function sendFittsTest() {
            testAttr.testID = document.getElementById("fittsTestID").value;
            testAttr.testStages = selectOptions;
            testAttr.testFinished = false;

            if((testAttr.testStages.length > 0) && (testAttr.testID != "")){
                $.ajax({
                    type: "POST",
                    url: "/PostFittsTest/",
                    data: JSON.stringify(testAttr),           //"fittsTest" will be value for @RequestParam
                    contentType: "application/json",
                    success: function (response) {
                        if (response.status = "OK") {
                            window.location.replace(response.redirect);
                        } else {
                            receiveError(response.errorMessage);
                        }
                    },
                    error: function (response) {
                        receiveError("Connection lost with the server! An error occurred when trying to contact the server.\nError-message: " + response.responseJSON.message);
                    }
                });
            } else {
                // error message
            }
        }

        function receiveError(response) {
            alert('We are sorry, but an error has occurred: ' + response);       //Reroute to error page
        }



        /*]]>*/
    </script>
</body>
</html>